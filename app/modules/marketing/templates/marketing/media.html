{% extends "base.html" %}

{% block title %}Media Management - {{ config.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col">
            <h1>üì∏ Media Management</h1>
            <p class="text-muted">Upload images and videos to post across Facebook, Instagram, and your website banner</p>
        </div>
        <div class="col-auto">
            {% if fb_configured %}
                <span class="badge bg-success">‚úì Facebook Connected</span>
            {% else %}
                <span class="badge bg-warning">‚ö† Facebook Not Connected</span>
            {% endif %}
        </div>
    </div>

    <!-- Two-Column Layout: Form on Left, Recent Promotions on Right -->
    <div class="row">
        <!-- LEFT COLUMN: Upload Form -->
        <div class="col-lg-8">
            <!-- Upload Form -->
            <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Upload New Media</h5>
        </div>
        <div class="card-body">
            <form method="POST" enctype="multipart/form-data" id="mediaForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="title" class="form-label">Title *</label>
                        <input type="text" class="form-control" id="title" name="title" placeholder="e.g., Summer Sale 2026" required>
                    </div>
                    <div class="col-md-6">
                        <label for="description" class="form-label">Description</label>
                        <input type="text" class="form-control" id="description" name="description" placeholder="Optional description">
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-12">
                        <label for="link_url" class="form-label">Click-Through URL</label>
                        <input type="url" class="form-control" id="link_url" name="link_url" placeholder="https://example.com">
                    </div>
                </div>

                <!-- File Upload with Drag & Drop -->
                <div class="mb-3">
                    <label for="media" class="form-label">Select Image or Video *</label>

                    <!-- Drag & Drop Zone -->
                    <div id="dropZone" class="border-2 border-dashed border-primary rounded-lg p-4 text-center cursor-pointer transition-all" style="background-color: #f8f9ff; cursor: pointer;">
                        <div class="py-3">
                            <svg class="mx-auto mb-2" width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                            </svg>
                            <p class="mb-1 font-weight-bold">Drag and drop your file here</p>
                            <p class="text-muted mb-0"><small>or click to browse</small></p>
                        </div>
                        <input type="file" id="media" name="media" accept="image/*,video/*" class="d-none" required>
                    </div>

                    <small class="text-muted d-block mt-2">
                        Supported: JPG, PNG, GIF (images) or MP4, MOV, AVI, WebM (videos)
                    </small>

                    <!-- File Preview Section -->
                    <div id="filePreview" class="mt-3" style="display: none;">
                        <div class="card">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div id="previewImage" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; background-color: #f0f0f0; display: flex; align-items: center; justify-content: center;">
                                            <small class="text-muted">Preview</small>
                                        </div>
                                    </div>
                                    <div class="col-md-9">
                                        <div class="mb-2">
                                            <strong>File Name:</strong> <span id="previewFileName"></span>
                                        </div>
                                        <div class="mb-2">
                                            <strong>File Size:</strong> <span id="previewFileSize"></span>
                                        </div>
                                        <div class="mb-2">
                                            <strong>File Type:</strong> <span id="previewFileType"></span>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" id="changeFileBtn">
                                            √ó Change File
                                        </button>
                                    </div>
                                </div>

                                <!-- Upload Progress (only shown during upload) -->
                                <div id="uploadProgress" style="display: none; margin-top: 15px;">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span><strong>Uploading your file...</strong></span>
                                        <span id="uploadPercentage">0%</span>
                                    </div>
                                    <div class="progress" style="height: 24px;">
                                        <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Destinations -->
                <div class="mb-3">
                    <label class="form-label">Where should this appear? *</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="post_to_banner" name="post_to_banner" value="on" checked>
                        <label class="form-check-label" for="post_to_banner">
                            <strong>üåê Website Banner</strong> - Display on dealer homepage carousel
                        </label>
                    </div>
                    {% if fb_configured %}
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="post_to_facebook" name="post_to_facebook" value="on">
                        <label class="form-check-label" for="post_to_facebook">
                            <strong>üëç Facebook</strong> - Post to Facebook page
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="post_to_instagram" name="post_to_instagram" value="on">
                        <label class="form-check-label" for="post_to_instagram">
                            <strong>üì± Instagram</strong> - Cross-post to Instagram
                        </label>
                    </div>
                    {% else %}
                    <p class="text-warning"><small>‚ö† Connect Facebook to post to social media</small></p>
                    {% endif %}
                </div>

                <!-- Scheduling -->
                <div class="mb-3">
                    <label class="form-label">When should it post?</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="schedule_mode" id="schedule_now" value="now" checked>
                        <label class="form-check-label" for="schedule_now">
                            Post Immediately
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="schedule_mode" id="schedule_later" value="scheduled">
                        <label class="form-check-label" for="schedule_later">
                            Schedule for Later
                        </label>
                    </div>
                    <div id="scheduleOptions" style="display: none; margin-top: 10px;">
                        <div class="row">
                            <div class="col-md-6">
                                <input type="date" class="form-control" id="scheduled_date" name="scheduled_date">
                            </div>
                            <div class="col-md-6">
                                <input type="time" class="form-control" id="scheduled_time" name="scheduled_time">
                            </div>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-upload"></i> Upload & Post
                </button>
            </form>
        </div>
            </div>
            <!-- End Upload Form Card -->
        </div>
        <!-- End Left Column -->

        <!-- RIGHT COLUMN: Recent Promotions -->
        <div class="col-lg-4">
            <!-- Recent Promotions -->
            <div class="card">
        <div class="card-header bg-info text-white">
            <div class="d-flex align-items-center">
                <span style="font-size: 1.3em; margin-right: 10px;">‚è±Ô∏è</span>
                <h5 class="mb-0">Recent Promotions</h5>
            </div>
        </div>
        <div class="card-body" style="max-height: 600px; overflow-y: auto;">
            {% if media_items %}
                {% for media in media_items %}
                <div class="mb-4 pb-3" style="border-bottom: 1px solid #e0e0e0;">
                    <!-- Promotion Title and Status -->
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <h6 class="mb-1" style="font-weight: 600; color: #333;">{{ media.title }}</h6>
                            <small class="text-muted">
                                {% if media.status == 'posted' %}
                                    Posted: {{ media.created_at.strftime('%b %d, %I:%M %p') }}
                                {% elif media.status == 'scheduled' and media.scheduled_post_time %}
                                    Scheduled: {{ media.scheduled_post_time.strftime('%b %d, %I:%M %p') }}
                                {% else %}
                                    Created: {{ media.created_at.strftime('%b %d, %I:%M %p') }}
                                {% endif %}
                            </small>
                        </div>
                        {% if media.status == 'posted' %}
                            <span class="badge bg-success" style="font-size: 0.85em;">‚úì Posted</span>
                        {% elif media.status == 'scheduled' %}
                            <span class="badge bg-info" style="font-size: 0.85em;">üìÖ Scheduled</span>
                        {% elif media.status == 'draft' %}
                            <span class="badge bg-secondary" style="font-size: 0.85em;">Draft</span>
                        {% else %}
                            <span class="badge bg-warning" style="font-size: 0.85em;">{{ media.status }}</span>
                        {% endif %}
                    </div>

                    <!-- Description -->
                    {% if media.description %}
                    <p class="small text-muted mb-2">{{ media.description }}</p>
                    {% endif %}

                    <!-- Destination Badges -->
                    <div class="mb-2">
                        {% if media.post_to_facebook %}
                            <span class="badge me-2" style="background-color: #1877F2; font-size: 0.85em;">üëç FB</span>
                        {% endif %}
                        {% if media.post_to_instagram %}
                            <span class="badge me-2" style="background-color: #E4405F; font-size: 0.85em;">üì± IG</span>
                        {% endif %}
                        {% if media.post_to_banner %}
                            <span class="badge me-2 bg-primary" style="font-size: 0.85em;">üåê Banner</span>
                        {% endif %}
                    </div>

                    <!-- Action Buttons -->
                    <div class="btn-group btn-group-sm" role="group" aria-label="Promotion actions">
                        <button type="button" class="btn btn-outline-secondary" onclick="editMedia({{ media.id }})" title="Edit">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="viewDetails({{ media.id }})" title="View Details">
                            <i class="bi bi-eye"></i>
                        </button>
                        <form method="POST" action="{{ url_for('marketing.delete_media', id=media.id) }}" style="display: inline;" onsubmit="return confirm('Delete this promotion?');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-outline-danger" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="text-center py-5">
                <p class="text-muted"><small>No promotions created yet. Upload your first one above!</small></p>
            </div>
            {% endif %}
        </div>
            </div>
            <!-- End Recent Promotions Card -->
        </div>
        <!-- End Right Column -->
    </div>
    <!-- End Row -->
</div>

<script>
// CHUNKED UPLOAD CONFIGURATION
const CHUNK_SIZE = 5 * 1024 * 1024; // 5MB chunks

// Toggle schedule options
document.getElementById('schedule_later').addEventListener('change', function() {
    document.getElementById('scheduleOptions').style.display = this.checked ? 'block' : 'none';
});

document.getElementById('schedule_now').addEventListener('change', function() {
    document.getElementById('scheduleOptions').style.display = !this.checked ? 'block' : 'none';
});

// ===== DRAG & DROP FUNCTIONALITY =====
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('media');

// Prevent default drag behaviors
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, false);
    document.body.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

// Highlight drop zone when item is dragged over it
['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, unhighlight, false);
});

function highlight(e) {
    dropZone.style.backgroundColor = '#e7f3ff';
    dropZone.style.borderColor = '#0066cc';
}

function unhighlight(e) {
    dropZone.style.backgroundColor = '#f8f9ff';
    dropZone.style.borderColor = '#007bff';
}

// Handle dropped files
dropZone.addEventListener('drop', handleDrop, false);

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    fileInput.files = files;

    // Trigger change event to show preview
    const event = new Event('change', { bubbles: true });
    fileInput.dispatchEvent(event);
}

// Click on drop zone to browse
dropZone.addEventListener('click', function(e) {
    if (e.target.tagName !== 'INPUT') {
        fileInput.click();
    }
});

// ===== FILE PREVIEW & SELECTION =====
let generatedThumbnailBlob = null; // Store thumbnail for upload

fileInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const previewDiv = document.getElementById('filePreview');
    const previewImage = document.getElementById('previewImage');
    const previewFileName = document.getElementById('previewFileName');
    const previewFileSize = document.getElementById('previewFileSize');
    const previewFileType = document.getElementById('previewFileType');

    // Update preview info
    previewFileName.textContent = file.name;
    previewFileSize.textContent = (file.size / 1024 / 1024).toFixed(2) + ' MB';
    previewFileType.textContent = file.type || 'Unknown';

    // Show preview
    const isImage = file.type.startsWith('image/');
    const isVideo = file.type.startsWith('video/');

    if (isImage) {
        generatedThumbnailBlob = null; // No thumbnail needed for images
        const reader = new FileReader();
        reader.onload = function(event) {
            previewImage.innerHTML = `<img src="${event.target.result}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">`;
        };
        reader.readAsDataURL(file);
    } else if (isVideo) {
        // Use Blob URL instead of data URL for better browser compatibility
        const blobUrl = URL.createObjectURL(file);
        const video = document.createElement('video');
        video.src = blobUrl;
        video.muted = true;

        let thumbnailGenerated = false;

        const handleSeeked = function() {
            if (thumbnailGenerated) return; // Only generate once
            thumbnailGenerated = true;

            try {
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                if (canvas.width === 0 || canvas.height === 0) {
                    console.warn('Video dimensions not available yet');
                    return;
                }

                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);

                // Save thumbnail as blob for later upload
                canvas.toBlob(function(blob) {
                    if (blob) {
                        generatedThumbnailBlob = blob;
                        console.log('Video thumbnail generated successfully:', blob.size, 'bytes');
                    } else {
                        console.warn('Failed to create thumbnail blob');
                    }
                }, 'image/jpeg', 0.8);

                // Show preview
                const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                previewImage.innerHTML = `<img src="${dataUrl}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">`;
                console.log('Video preview displayed');

                // Clean up event listeners
                video.removeEventListener('seeked', handleSeeked);
                video.removeEventListener('error', handleError);
            } catch (err) {
                console.error('Error generating video thumbnail:', err);
                // Fallback: show a gray placeholder with text
                previewImage.innerHTML = `<div style="width: 100%; height: 100%; background-color: #cccccc; border-radius: 8px; display: flex; align-items: center; justify-content: center;"><span class="text-muted" style="font-size: 12px;">Video Thumbnail</span></div>`;
            }
        };

        const handleError = function(err) {
            console.error('Video loading error:', err);
            previewImage.innerHTML = `<div style="width: 100%; height: 100%; background-color: #ffcccc; border-radius: 8px; display: flex; align-items: center; justify-content: center;"><span class="text-danger" style="font-size: 12px;">Error loading video</span></div>`;
        };

        video.addEventListener('seeked', handleSeeked);
        video.addEventListener('error', handleError);
        video.addEventListener('loadedmetadata', function() {
            console.log('Video metadata loaded:', video.videoWidth, 'x', video.videoHeight);
            // Seek to first frame (0.1 seconds in)
            try {
                video.currentTime = 0.1;
            } catch (err) {
                console.error('Error seeking video:', err);
            }
        });

        // Clean up blob URL when done
        setTimeout(() => {
            if (thumbnailGenerated) {
                URL.revokeObjectURL(blobUrl);
                console.log('Blob URL cleaned up');
            }
        }, 5000);
    }

    previewDiv.style.display = 'block';
});

// Change file button
document.getElementById('changeFileBtn').addEventListener('click', function() {
    fileInput.click();
});

// ===== CHUNKED UPLOAD FUNCTIONALITY =====
document.getElementById('mediaForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const file = fileInput.files[0];
    if (!file) {
        alert('Please select a file');
        return;
    }

    // For small files (< 10MB), use regular upload
    if (file.size < 10 * 1024 * 1024) {
        // For regular form submission, we need to include thumbnail if available
        // Since thumbnail is a blob and form is multipart, we'll use fetch with FormData instead
        const formData = new FormData(document.getElementById('mediaForm'));

        // Add thumbnail if we generated one (for videos)
        if (generatedThumbnailBlob) {
            formData.append('thumbnail', generatedThumbnailBlob, 'thumbnail.jpg');
        }

        // Include scheduled date/time if scheduling for later
        const scheduleLaterRadio = document.getElementById('schedule_later');
        if (scheduleLaterRadio && scheduleLaterRadio.checked) {
            formData.set('schedule_mode', 'scheduled');  // Override form value
            const scheduledDate = document.getElementById('scheduled_date')?.value;
            const scheduledTime = document.getElementById('scheduled_time')?.value;
            if (scheduledDate) formData.set('scheduled_date', scheduledDate);
            if (scheduledTime) formData.set('scheduled_time', scheduledTime);
        } else {
            formData.set('schedule_mode', 'now');  // Ensure schedule_mode is set to 'now'
        }

        try {
            const response = await fetch('/marketing', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                // Check if this was scheduled for later
                const scheduleLater = document.getElementById('schedule_later')?.checked;
                const successMessage = scheduleLater
                    ? 'File uploaded successfully and scheduled for later posting!'
                    : 'File uploaded successfully and queued for posting!';
                alert(successMessage);
                window.location.reload();
            } else {
                throw new Error('Upload failed with status ' + response.status);
            }
        } catch (error) {
            alert('Upload failed: ' + error.message);
        }
        return;
    }

    // For large files, use chunked upload
    await uploadFileInChunks(file);
});

async function uploadFileInChunks(file) {
    const uploadProgressDiv = document.getElementById('uploadProgress');
    const uploadProgressBar = document.getElementById('uploadProgressBar');
    const uploadPercentage = document.getElementById('uploadPercentage');

    // Show progress bar
    uploadProgressDiv.style.display = 'block';

    try {
        // Step 1: Initialize upload session
        const initResponse = await fetch('/marketing/init-chunk-upload', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!initResponse.ok) {
            throw new Error('Failed to initialize upload');
        }

        const initData = await initResponse.json();
        const uploadId = initData.uploadId;

        // Step 2: Upload chunks
        const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
        let uploadedChunks = 0;

        for (let i = 0; i < totalChunks; i++) {
            const start = i * CHUNK_SIZE;
            const end = Math.min(start + CHUNK_SIZE, file.size);
            const chunk = file.slice(start, end);

            const formData = new FormData();
            formData.append('uploadId', uploadId);
            formData.append('chunkIndex', i);
            formData.append('totalChunks', totalChunks);
            formData.append('chunk', chunk);

            const chunkResponse = await fetch('/marketing/upload-chunk', {
                method: 'POST',
                body: formData
            });

            if (!chunkResponse.ok) {
                throw new Error(`Failed to upload chunk ${i + 1}`);
            }

            uploadedChunks++;
            const progress = (uploadedChunks / totalChunks) * 100;
            uploadProgressBar.style.width = progress + '%';
            uploadPercentage.textContent = Math.round(progress) + '%';
        }

        // Step 3: Complete upload and process
        const formData = new FormData();
        formData.append('uploadId', uploadId);
        formData.append('title', document.getElementById('title').value);
        formData.append('content', document.getElementById('description').value);
        formData.append('link_url', document.getElementById('link_url').value);

        // Safely append checkbox values with null checks
        const facebookCheckbox = document.getElementById('post_to_facebook');
        const instagramCheckbox = document.getElementById('post_to_instagram');
        const bannerCheckbox = document.getElementById('post_to_banner');

        formData.append('post_to_facebook', facebookCheckbox ? facebookCheckbox.checked : false);
        formData.append('post_to_instagram', instagramCheckbox ? instagramCheckbox.checked : false);
        formData.append('post_to_banner', bannerCheckbox ? bannerCheckbox.checked : false);

        // Include scheduled date/time if scheduling for later
        const scheduleLaterRadio = document.getElementById('schedule_later');
        if (scheduleLaterRadio && scheduleLaterRadio.checked) {
            formData.append('schedule_mode', 'scheduled');
            const scheduledDate = document.getElementById('scheduled_date')?.value;
            const scheduledTime = document.getElementById('scheduled_time')?.value;
            if (scheduledDate) formData.append('scheduled_date', scheduledDate);
            if (scheduledTime) formData.append('scheduled_time', scheduledTime);
        } else {
            formData.append('schedule_mode', 'now');
        }

        // Include thumbnail if we generated one (for videos)
        if (generatedThumbnailBlob) {
            formData.append('thumbnail', generatedThumbnailBlob, 'thumbnail.jpg');
        }

        const completeResponse = await fetch('/marketing/complete-chunk-upload', {
            method: 'POST',
            body: formData
        });

        if (!completeResponse.ok) {
            throw new Error('Failed to complete upload');
        }

        // Success!
        uploadPercentage.textContent = '100%';
        uploadProgressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
        uploadProgressBar.style.backgroundColor = '#28a745';

        // Check if this was scheduled for later
        const scheduleLater = document.getElementById('schedule_later')?.checked;
        const successMessage = scheduleLater
            ? 'File uploaded successfully and scheduled for later posting!'
            : 'File uploaded successfully and queued for posting!';

        setTimeout(() => {
            alert(successMessage);
            window.location.reload();
        }, 1500);

    } catch (error) {
        alert('Upload failed: ' + error.message);
        uploadProgressDiv.style.display = 'none';
        console.error('Upload error:', error);
    }
}

function editMedia(id) {
    // TODO: Implement edit modal
    alert('Edit functionality coming soon!');
}

function viewDetails(id) {
    // TODO: Implement view details modal
    alert('View details functionality coming soon!');
}
</script>

<style>
.badge { margin-right: 4px; }
.table-responsive { margin-top: 20px; }
</style>
{% endblock %}
