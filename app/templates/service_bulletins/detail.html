{% extends "base.html" %}
{% block title %}Bulletin {{ sb.sb_number }} | {{ g.current_org.name }}{% endblock %}

{% block content %}
<style>
    .sb-ribbon {
        background-color: #ffc107;
        margin: -1.5rem -1.5rem 2rem -1.5rem;
        padding: 1.5rem;
        border-bottom: 5px solid #e0a800;
    }

    .sb-title-banner {
        font-weight: 800;
        font-size: 1.75rem;
    }

    .completion-scroll {
        max-height: 400px;
        overflow-y: auto;
    }

    .action-btn-green {
        background-color: #198754;
        color: white;
    }

    .action-btn-green:hover {
        background-color: #157347;
        color: white;
    }
</style>

<div class="mb-4 d-flex justify-content-between align-items-center">
    <div>
        <h2 class="mb-0"><i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>SB-{{ sb.sb_number }}</h2>
    </div>
    <div class="d-flex gap-2">
        <a href="#" class="btn btn-outline-primary btn-sm"><i class="bi bi-pencil me-1"></i>Edit</a>
        <a href="{{ url_for('service_bulletins.index') }}" class="btn btn-outline-secondary btn-sm"><i
                class="bi bi-arrow-left me-1"></i>Back to List</a>
    </div>
</div>

<div class="sb-ribbon shadow-sm">
    <div class="sb-title-banner">{{ sb.title }}</div>
    <div class="row mt-3">
        <div class="col-md-4">
            <span class="fw-bold">Issue Date:</span> {{ sb.issue_date.strftime('%B %d, %Y') }}
        </div>
        <div class="col-md-4">
            <span class="fw-bold">SB Number:</span> {{ sb.sb_number }}
        </div>
    </div>
    <div class="row mt-2">
        <div class="col-md-4">
            <span class="fw-bold">Warranty Code:</span> {{ sb.warranty_code or '-' }}
        </div>
        <div class="col-md-4">
            <span class="fw-bold">Labor Hours:</span> {{ sb.labor_hours or '-' }}
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-8">
        <div class="mb-4">
            <h5 class="fw-bold border-bottom pb-2">Required Parts:</h5>
            {% if sb.parsed_required_parts %}
            <ul class="list-group list-group-flush">
                {% for part in sb.parsed_required_parts %}
                <li class="list-group-item bg-transparent px-0 border-0">â€¢ {{ part }}</li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-muted small">None listed.</p>
            {% endif %}
        </div>

        <div class="mb-4">
            <h5 class="fw-bold border-bottom pb-2">Affected Models & Serial Ranges:</h5>
            <div class="table-responsive">
                <table class="table table-hover table-sm">
                    <thead>
                        <tr>
                            <th class="py-2">Model</th>
                            <th class="py-2">Serial Range</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for model in sb.affected_models %}
                        <tr>
                            <td class="fw-bold py-2">{{ model.model_name }}</td>
                            <td class="font-monospace text-danger py-2">
                                {{ model.serial_start }} to {{ model.serial_end }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="mb-4">
            <h5 class="fw-bold border-bottom pb-2">Description:</h5>
            <div class="text-secondary" style="white-space: pre-wrap;">{{ sb.description }}</div>
        </div>

        {% if sb.pdf_filename %}
        <div class="mb-4">
            <h5 class="fw-bold border-bottom pb-2">PDF Viewer</h5>
            <div class="card border-0 shadow-sm" style="height: 600px;">
                <iframe
                    src="{{ url_for('static', filename='uploads/bulletins/' ~ g.current_org_id ~ '/' ~ sb.pdf_filename) }}"
                    width="100%" height="100%" class="rounded">
                </iframe>
            </div>
        </div>
        {% endif %}

        <div class="d-flex gap-3 mt-4">
            {% if sb.pdf_filename %}
            <a href="{{ url_for('static', filename='uploads/bulletins/' ~ g.current_org_id ~ '/' ~ sb.pdf_filename) }}"
                target="_blank" class="btn btn-primary px-4">
                <i class="bi bi-box-arrow-up-right me-2"></i>Open PDF in New Window
            </a>
            {% endif %}
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Actions Card -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-light fw-bold py-3">Actions</div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('service_bulletins.complete', sb_id=sb.id) }}"
                        class="btn action-btn-green py-2">
                        <i class="bi bi-check-circle me-2"></i>Record Completion
                    </a>
                    <form action="{{ url_for('service_bulletins.delete', sb_id=sb.id) }}" method="POST"
                        onsubmit="return confirm('Are you sure you want to delete this bulletin? This cannot be undone.');">
                        <button class="btn btn-outline-danger w-100 btn-sm"><i class="bi bi-trash me-2"></i>Delete
                            Bulletin</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Completion History -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light fw-bold py-3">
                Completion History ({{ completions|length }})
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush completion-scroll">
                    {% for c in completions %}
                    <div class="list-group-item py-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="fw-bold font-monospace text-primary fs-5">{{ c.serial_number }}</span>
                            <a href="#" class="text-primary small"><i class="bi bi-pencil"></i></a>
                        </div>
                        <div class="mb-1"><span class="badge bg-success small">Completed</span></div>
                        <div class="small text-muted">
                            {{ c.user.username }} - {{ c.completion_date.strftime('%m/%d/%Y') }}
                        </div>
                        {% if c.notes %}
                        <div class="small mt-2 p-2 bg-light rounded border-start border-3">
                            "{{ c.notes }}"
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="list-group-item text-center py-4 text-muted">
                        No completions recorded yet.
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}