{% extends "_base.html" %}

{% block title %}Manage Knowledge Base{% endblock %}

{% block head_styles %}
<style>
    #drop-zone {
        border: 2px dashed #ccc;
        border-radius: .5rem;
        padding: 40px;
        text-align: center;
        color: #6c757d;
        transition: border-color 0.3s, background-color 0.3s;
    }
    #drop-zone.dragover {
        border-color: #0d6efd;
        background-color: #e9f2ff;
    }
    .file-size {
        font-size: 0.8em;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="mb-0"><i class="bi bi-book-half me-2"></i>Manage Knowledge Base</h1>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">‚Üê Back to Dashboard</a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {% if not bucket_configured %}
        <div class="alert alert-danger">
            The Knowledge Base feature is not configured on the server. Please set the <code>KNOWLEDGE_BASE_GCS_BUCKET</code> environment variable.
        </div>
    {% else %}
    <div class="row">
        <!-- Upload Section -->
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Upload New Files</h5>
                </div>
                <div class="card-body">
                    <div id="drop-zone">
                        <p>Drag & drop files here or click to select</p>
                        <input type="file" id="file-input" multiple style="display: none;">
                    </div>
                    <div id="upload-progress-container" class="mt-3"></div>
                </div>
            </div>
        </div>

        <!-- File List Section -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <form method="GET" action="{{ url_for('manage_knowledge_base') }}" class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Existing Files (Newest First)</h5>
                        <div class="input-group" style="max-width: 300px;">
                            <input type="text" name="search" class="form-control form-control-sm" placeholder="Search files by name..." value="{{ search_query or '' }}">
                            <button class="btn btn-sm btn-outline-secondary" type="submit"><i class="bi bi-search"></i></button>
                        </div>
                    </form>
                </div>
                <div class="card-body">
                    {% if files %}
                    <ul class="list-group list-group-flush" id="file-list">
                        {% for file in files %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <a href="{{ file.url }}" target="_blank">{{ file.name }}</a>
                                <br>
                                <small class="text-muted">
                                    Size: {{ (file.size / 1024)|round(2) }} KB | 
                                    Updated: <span class="local-datetime" data-timestamp="{{ file.updated.isoformat() }}Z">{{ file.updated.strftime('%b %d, %Y') }}</span>
                                </small>
                            </div>
                            <form action="{{ url_for('delete_knowledge_base_file', filename=file.name) }}" method="POST" onsubmit="return confirm('Are you sure you want to permanently delete this file?');" style="display: inline;">
                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete {{ file.name }}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </li>
                        {% endfor %}
                    </ul>
                    {% elif search_query %}
                    <p class="text-muted">No files match your search for "{{ search_query }}".</p>
                    {% else %}
                    <p class="text-muted">No files found in the knowledge base.</p>
                    {% endif %}
                </div>
                <div class="card-footer bg-white">
                    {% if total_pages > 1 %}
                    <nav aria-label="File list navigation">
                        <ul class="pagination pagination-sm justify-content-center mb-0">
                            {# Previous Button #}
                            <li class="page-item {% if current_page <= 1 %}disabled{% endif %}">
                                <a class="page-link" href="{{ url_for('manage_knowledge_base', page=current_page-1, search=search_query) }}">Previous</a>
                            </li>

                            {% set window = 2 %}
                            {% set show_first_ellipsis = current_page > window + 2 %}
                            {% set show_last_ellipsis = current_page < total_pages - (window + 1) %}

                            {# First page and ellipsis #}
                            {% if show_first_ellipsis %}
                                <li class="page-item"><a class="page-link" href="{{ url_for('manage_knowledge_base', page=1, search=search_query) }}">1</a></li>
                                <li class="page-item disabled"><span class="page-link">&hellip;</span></li>
                            {% endif %}

                            {# Page numbers in the window #}
                            {% for p in range(1, total_pages + 1) %}
                                {% if p >= current_page - window and p <= current_page + window %}
                                <li class="page-item {% if p == current_page %}active{% endif %}"><a class="page-link" href="{{ url_for('manage_knowledge_base', page=p, search=search_query) }}">{{ p }}</a></li>
                                {% endif %}
                            {% endfor %}

                            {# Last page and ellipsis #}
                            {% if show_last_ellipsis %}
                                <li class="page-item disabled"><span class="page-link">&hellip;</span></li>
                                <li class="page-item"><a class="page-link" href="{{ url_for('manage_knowledge_base', page=total_pages, search=search_query) }}">{{ total_pages }}</a></li>
                            {% endif %}

                            {# Next Button #}
                            <li class="page-item {% if current_page >= total_pages %}disabled{% endif %}">
                                <a class="page-link" href="{{ url_for('manage_knowledge_base', page=current_page+1, search=search_query) }}">Next</a>
                            </li>
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block body_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const progressContainer = document.getElementById('upload-progress-container');

    if (!dropZone) return;

    // --- Event Listeners ---
    dropZone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => handleFiles(fileInput.files));

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    });

    // --- File Handling and Uploading ---
    const handleFiles = (files) => {
        [...files].forEach(uploadFile);
    };

    const uploadFile = (file) => {
        const formData = new FormData();
        formData.append('file', file);

        const progressId = `progress-${Math.random().toString(36).substr(2, 9)}`;
        const progressHtml = `
            <div id="${progressId}">
                <div class="d-flex justify-content-between">
                    <small>${file.name}</small>
                    <small class="status">Uploading...</small>
                </div>
                <div class="progress" style="height: 5px;">
                    <div class="progress-bar" role="progressbar" style="width: 0%;"></div>
                </div>
            </div>
        `;
        progressContainer.insertAdjacentHTML('beforeend', progressHtml);

        const xhr = new XMLHttpRequest();
        xhr.open('POST', "{{ url_for('upload_knowledge_base_file') }}", true);

        xhr.upload.addEventListener('progress', (e) => {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                document.querySelector(`#${progressId} .progress-bar`).style.width = `${percentComplete}%`;
            }
        });

        xhr.onload = () => {
            const progressBar = document.querySelector(`#${progressId} .progress-bar`);
            const statusEl = document.querySelector(`#${progressId} .status`);
            if (xhr.status >= 200 && xhr.status < 300) {
                progressBar.classList.add('bg-success');
                statusEl.textContent = 'Success!';
                statusEl.classList.add('text-success');
                // Refresh the page to show the new file in the list
                setTimeout(() => window.location.reload(), 1000);
            } else {
                progressBar.classList.add('bg-danger');
                const response = JSON.parse(xhr.responseText);
                statusEl.textContent = `Error: ${response.error || 'Upload failed'}`;
                statusEl.classList.add('text-danger');
            }
        };

        xhr.onerror = () => {
            document.querySelector(`#${progressId} .progress-bar`).classList.add('bg-danger');
            document.querySelector(`#${progressId} .status`).textContent = 'Network Error';
            document.querySelector(`#${progressId} .status`).classList.add('text-danger');
        };

        xhr.send(formData);
    };

    // Format timestamps on this page
    // The global function is defined in _base.html
    if (typeof formatTimestamps === 'function') {
        formatTimestamps();
    } else {
        console.error("formatTimestamps function not found. Make sure this template extends _base.html.");
    }
});
</script>
{% endblock %}