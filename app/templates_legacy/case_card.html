<a href="{{ url_for('view_case', case_id=case.id) }}" class="card-link">
    <div class="card mb-2">
        <div class="card-body p-2">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h6 class="card-title mb-1">
                        #{{ case.id }} - {{ case.dealer.name if case.dealer else 'No Dealer' }}
                    </h6>
                    <p class="card-text small text-muted mb-1">{{ (case.reference or '') | html_to_plaintext | truncate(60) }}</p>
                    {% if case.status == 'Scheduled' and case.appointment_date %}
                    <p class="card-text text-danger small mb-1">
                        <i class="bi bi-calendar-check-fill"></i>
                        <strong>Scheduled:</strong> {{ case.appointment_date }}
                    </p>
                    {% endif %}
                    {% if case.status == 'Follow Up' and case.follow_up_date %}
                    <p class="card-text text-primary small mb-1">
                        <i class="bi bi-arrow-clockwise"></i>
                        <strong>Follow-up:</strong> {{ case.formatted_follow_up_date }}
                    </p>
                    {% endif %}
                    {% if case.case_type == 'Internal Repair' and case.total_repair_cost > 0 %}
                    <p class="card-text text-danger small mb-1">
                        <i class="bi bi-currency-dollar"></i>
                        <strong>Total Cost:</strong> {{ case.total_repair_cost | currency }}
                    </p>
                    {% endif %}
                    <small class="text-muted">
                        Assigned: {{ case.assigned_to or 'Unassigned' }} | 
                        Created: <span class="local-datetime" data-timestamp="{{ case.creation_timestamp.isoformat() }}Z">{{ case.creation_timestamp.strftime('%b %d, %Y') }}</span>
                    </small>
                </div>
                <div class="text-end">
                    {% if case.unit %}
                    <div class="mb-2">
                        <span class="d-block text-muted small">Model: {{ case.unit.model_number or 'N/A' }}</span>
                        <span class="d-block text-muted small">S/N: {{ case.unit.serial_number or 'N/A' }}</span>
                    </div>
                    {% endif %}
                    {% set final_status = 'Completed' if case.is_visit else 'Resolved' %}
                    {% if case.status != final_status and case.status != 'Completed' and case.status != 'Resolved' %}
                        <form action="{{ url_for('quick_resolve_case', case_id=case.id) }}" method="POST" class="d-inline" onsubmit="event.stopPropagation(); return confirm('Are you sure you want to close this case?');">
                            <button type="submit" class="btn btn-success btn-sm" title="Mark as {{ final_status }}" style="min-width: 100px;">
                                <i class="bi bi-check2-circle"></i> Quick Close
                            </button>
                        </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</a>
