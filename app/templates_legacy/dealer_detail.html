{% extends "_base.html" %}

{% block title %}Dealer: {{ dealer.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <a href="{{ url_for('manage_dealers') }}" class="btn btn-secondary btn-sm">‚Üê Back to Dealer List</a>
        <div>
            <a href="{{ url_for('edit_dealer', dealer_id=dealer.id) }}" class="btn btn-primary btn-sm">Edit Dealer</a>
            <a href="{{ url_for('add_case', dealer_id=dealer.id) }}" class="btn btn-success btn-sm">Add Case for
                Dealer</a>
            <form action="{{ url_for('delete_dealer', dealer_id=dealer.id) }}" method="POST" class="d-inline"
                onsubmit="return confirm('Are you sure you want to delete this dealer?');">
                <button type="submit" class="btn btn-danger btn-sm">Delete Dealer</button>
            </form>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h3>{{ dealer.name }}</h3>
            {% if dealer.dealer_dba %}<h5 class="text-muted">DBA: {{ dealer.dealer_dba }}</h5>{% endif %}
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h5>Details</h5>
                    <p class="mb-2"><strong>Dealer Code:</strong> {{ dealer.dealer_code or 'N/A' }}</p>
                    <p class="mb-2"><strong>Address:</strong> {{ dealer.address or 'N/A' }}
                        {% if dealer.address %}
                        <a href="https://www.google.com/maps/search/?api=1&query={{ dealer.address|urlencode }}"
                            class="btn btn-outline-secondary btn-sm py-0 px-1 ms-2" target="_blank"
                            title="View on Map"><i class="bi bi-geo-alt-fill"></i></a>
                        {% endif %}
                    </p>
                    <p><strong>Labor Rate:</strong> {{ dealer.labor_rate or 'N/A' }}</p>
                    <p><strong>Manufacturers:</strong> {{ dealer.manufacturers or 'N/A' }}</p>
                </div>
                <div class="col-md-6">
                    <h5>General Notes</h5>
                    <p>{{ dealer.notes or 'No general notes.' }}</p>
                    <hr>
                    <h5 id="notes-section">Note History</h5>

                    {% macro render_dealer_note_body(note, dealer_id) %}
                    <div id="note-{{ note.id }}">
                        <div class="d-flex justify-content-between">
                            <p class="mb-1">{{ note.rendered_html | safe }}</p>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-light py-0 px-2" type="button"
                                    data-bs-toggle="dropdown"><i class="bi bi-three-dots-vertical"></i></button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><button class="dropdown-item" data-bs-toggle="modal"
                                            data-bs-target="#editDealerNoteModal-{{ note.id }}">Edit</button></li>
                                    <li>
                                        <form
                                            action="{{ url_for('delete_dealer_note', dealer_id=dealer_id, note_id=note.id) }}"
                                            method="POST" onsubmit="return confirm('Are you sure?');"><button
                                                type="submit" class="dropdown-item text-danger">Delete</button></form>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <small class="text-muted">{{ note.user or 'System' }} on <span class="local-datetime"
                                data-timestamp="{{ note.timestamp.isoformat() }}Z">{{ note.timestamp.strftime('%Y-%m-%d
                                %H:%M') }} UTC</span></small>
                        <!-- Reply Button & Form -->
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="modal"
                                data-bs-target="#replyDealerNoteModal-{{ note.id }}">
                                <i class="bi bi-reply"></i> Reply
                            </button>
                        </div>
                    </div>
                    {% endmacro %}

                    {% macro render_dealer_replies(notes, dealer_id) %}
                    {% for reply in notes|sort(attribute='timestamp') %}
                    <div class="d-flex gap-3 mt-3 pt-3 border-top">
                        <div class="text-primary pt-1"><i class="bi bi-arrow-return-right"></i></div>
                        <div class="flex-grow-1">
                            {{ render_dealer_note_body(reply, dealer_id) }}
                            {% if reply.replies.count() > 0 %}
                            {{ render_dealer_replies(reply.replies, dealer_id) }}
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    {% endmacro %}

                    <div class="note-thread-container">
                        {% for note in dealer.dealer_notes|selectattr("parent_id", "equalto",
                        none)|sort(attribute='timestamp', reverse=True) %}
                        <div class="mb-3 p-2 border-bottom">
                            {{ render_dealer_note_body(note, dealer.id) }}
                            {% if note.replies.count() > 0 %}
                            <div class="mt-2">
                                <a class="btn btn-sm btn-outline-secondary rounded-pill" data-bs-toggle="collapse"
                                    href="#collapse-dealer-thread-{{ note.id }}" role="button">
                                    <i class="bi bi-diagram-3"></i> View {{ note.replies.count() }} replies
                                </a>
                            </div>
                            <div class="collapse mt-2" id="collapse-dealer-thread-{{ note.id }}">
                                <div class="p-3 bg-light rounded-2">
                                    {{ render_dealer_replies(note.replies, dealer.id) }}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% else %}
                        <p class="text-muted">No note history yet.</p>
                        {% endfor %}
                    </div>
                    <hr>
                    <p>
                        <a class="btn btn-outline-primary btn-sm" data-bs-toggle="collapse" href="#addNoteForm"
                            role="button" aria-expanded="false" aria-controls="addNoteForm">
                            <i class="bi bi-plus-circle"></i> Add New Note
                        </a>
                    </p>
                    <div class="collapse mt-3" id="addNoteForm">
                        <div class="card card-body">
                            <h5>New Note</h5>
                            <form action="{{ url_for('add_dealer_note', dealer_id=dealer.id) }}" method="POST">
                                <div class="mb-3">
                                    <label for="new-dealer-note" class="form-label">Note Text</label>
                                    <textarea class="form-control mentionable-textarea" id="new-dealer-note"
                                        name="note_text" rows="3" placeholder="Add a new note..."></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary btn-sm">Add Note</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <hr>
            <h5>Contacts</h5>
            <div class="row">
                {% for contact in dealer.contacts %}
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h6 class="card-title">{{ contact.name or 'N/A' }}</h6>
                            <p class="card-subtitle mb-2 text-muted">{{ contact.role or 'Contact' }}</p>
                            <p class="card-text mb-1"><i class="bi bi-telephone"></i>
                                {% if contact.phone %}
                                <a href="tel:{{ contact.phone }}">{{ contact.phone }}</a>
                                {% else %}
                                N/A
                                {% endif %}
                            </p>
                            <p class="card-text"><i class="bi bi-envelope"></i> {{ contact.email or 'N/A' }}</p>
                            <div class="mt-2">
                                <a href="{{ url_for('edit_contact', contact_id=contact.id) }}"
                                    class="btn btn-sm btn-outline-primary">Edit</a>
                                <form action="{{ url_for('delete_contact', contact_id=contact.id) }}" method="POST"
                                    class="d-inline"
                                    onsubmit="return confirm('Are you sure you want to delete this contact?');">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="col">
                    <p class="text-muted">No contacts listed for this dealer.</p>
                </div>
                {% endfor %}
            </div>
            <hr>
            <p>
                <a class="btn btn-outline-primary btn-sm" data-bs-toggle="collapse" href="#addContactForm" role="button"
                    aria-expanded="false" aria-controls="addContactForm">
                    <i class="bi bi-plus-circle"></i> Add New Contact
                </a>
            </p>
            <div class="collapse mt-3" id="addContactForm">
                <div class="card card-body">
                    <h5>New Contact</h5>
                    <form action="{{ url_for('add_contact', dealer_id=dealer.id) }}" method="POST">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="contact_name" class="form-label">Name</label>
                                <input type="text" class="form-control" id="contact_name" name="name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="contact_role" class="form-label">Role</label>
                                <input type="text" class="form-control" id="contact_role" name="role">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="contact_email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="contact_email" name="email">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="contact_phone" class="form-label">Phone</label>
                                <input type="tel" class="form-control" id="contact_phone" name="phone">
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-secondary me-2" data-bs-toggle="collapse"
                                data-bs-target="#addContactForm" aria-expanded="false"
                                aria-controls="addContactForm">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Contact</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h4>Case History</h4>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Case ID</th>
                            <th>Status</th>
                            <th>Reference</th>
                            <th>Created On</th>
                            <th>Assigned To</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for case in cases %}
                        <tr>
                            <td><a href="{{ url_for('view_case', case_id=case.id, from_dealer_id=dealer.id) }}">{{ '#' ~
                                    case.id }}</a></td>
                            <td><span class="badge bg-secondary">{{ case.status }}</span></td>
                            <td>{{ case.reference|striptags|truncate(50) }}</td>
                            <td><span class="local-datetime" title="{{ case.creation_timestamp.isoformat() }}Z"
                                    data-timestamp="{{ case.creation_timestamp.isoformat() }}Z">{{
                                    case.creation_timestamp.strftime('%Y-%m-%d %H:%M') }} UTC</span></td>
                            <td>{{ case.assigned_to or 'Unassigned' }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center text-muted">No cases found for this dealer.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Edit Dealer Note Modals -->
{% for note in dealer.dealer_notes %}
<div class="modal fade" id="editDealerNoteModal-{{ note.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Note</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('edit_dealer_note', dealer_id=dealer.id, note_id=note.id) }}" method="POST">
                <div class="modal-body">
                    <textarea class="form-control" name="edited_note_text" rows="5">{{ note.text }}</textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<!-- Reply Dealer Note Modals (New) -->
{% for note in dealer.dealer_notes %}
<div class="modal fade" id="replyDealerNoteModal-{{ note.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reply to {{ note.user }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('add_dealer_note', dealer_id=dealer.id) }}" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="parent_note_id" value="{{ note.id }}">
                    <textarea class="form-control mentionable-textarea" name="note_text" rows="5"
                        placeholder="Write a reply..." required></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Post Reply</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<!-- Mention suggestions box - single element for the whole page -->
<div id="mention-suggestions" class="list-group"
    style="display: none; position: absolute; z-index: 1050; max-height: 200px; overflow-y: auto;"></div>

{% endblock %}

{% block body_scripts %}
<script>
    const showBrowserNotification = (title, options) => {
        // Only proceed if permission is granted and the service worker is active.
        if (Notification.permission === "granted" && 'serviceWorker' in navigator && navigator.serviceWorker.controller) {
            navigator.serviceWorker.controller.postMessage({
                type: 'SHOW_NOTIFICATION',
                payload: { title, options }
            });
        }
    };

    document.addEventListener('DOMContentLoaded', function () {
        // --- FEATURE: @MENTION AUTOCOMPLETE ---
        const mentionUsers = JSON.parse('{{ mention_data|safe }}');
        const mentionSuggestionsContainer = document.getElementById('mention-suggestions');
        const allMentionableTextareas = document.querySelectorAll('.mentionable-textarea');

        if (allMentionableTextareas.length > 0 && mentionSuggestionsContainer) {
            const hideSuggestions = () => {
                mentionSuggestionsContainer.style.display = 'none';
            };

            const showSuggestions = (textarea, query) => {
                const filteredUsers = mentionUsers.filter(u => u.key.toLowerCase().includes(query.toLowerCase()));

                mentionSuggestionsContainer.innerHTML = '';
                if (filteredUsers.length > 0) {
                    filteredUsers.forEach(user => {
                        const item = document.createElement('a');
                        item.href = '#';
                        item.className = 'list-group-item list-group-item-action py-1';
                        item.textContent = user.key; // Show "First Last (username)"
                        item.onmousedown = (e) => {
                            e.preventDefault();
                            const text = textarea.value;
                            const cursorPos = textarea.selectionStart;
                            const textBeforeCursor = text.substring(0, cursorPos);
                            const startPos = textBeforeCursor.lastIndexOf('@');
                            textarea.value = text.substring(0, startPos) + `@${user.value} ` + text.substring(cursorPos);
                            hideSuggestions();
                            textarea.focus();
                        };
                        mentionSuggestionsContainer.appendChild(item);
                    });

                    const rect = textarea.getBoundingClientRect();
                    mentionSuggestionsContainer.style.top = `${window.scrollY + rect.bottom}px`;
                    mentionSuggestionsContainer.style.left = `${window.scrollX + rect.left}px`;
                    mentionSuggestionsContainer.style.width = `${rect.width}px`;
                    mentionSuggestionsContainer.style.display = 'block';
                } else {
                    hideSuggestions();
                }
            };

            allMentionableTextareas.forEach(textarea => {
                textarea.addEventListener('input', (e) => {
                    const text = e.target.value;
                    const cursorPos = e.target.selectionStart;
                    const textBeforeCursor = text.substring(0, cursorPos);
                    const mentionMatch = textBeforeCursor.match(/@([\w\s\.]*)$/);

                    if (mentionMatch) {
                        showSuggestions(e.target, mentionMatch[1]);
                    } else {
                        hideSuggestions();
                    }
                });
                textarea.addEventListener('blur', () => setTimeout(hideSuggestions, 200));
            });
        }

        // Polls for new notifications from other users.
        const NOTIFICATION_POLL_INTERVAL = 20000; // 20 seconds

        const pollForNotifications = () => {
            fetch('/check_notifications')
                .then(response => response.ok ? response.json() : Promise.reject('Network error'))
                .then(notifications => {
                    if (notifications && notifications.length > 0) {
                        if (Notification.permission === "granted") {
                            showNotifications(notifications);
                        } else if (Notification.permission !== "denied") {
                            Notification.requestPermission().then(permission => {
                                if (permission === "granted") {
                                    showNotifications(notifications);
                                }
                            });
                        }
                    }
                })
                .catch(error => console.error('Error polling for notifications:', error));
        };

        const showNotifications = (notifications) => {
            notifications.forEach((notification, index) => {
                setTimeout(() => {
                    let tag = `notification-${notification.id}`; // Use unique notification ID for tag
                    let url = '#';

                    if (notification.case_id) {
                        url = `/case/${notification.case_id}`;
                    } else if (notification.dealer_note_id) {
                        url = `/dealer/{{ dealer.id }}#note-${notification.dealer_note_id}`;
                    }

                    showBrowserNotification("New Update", {
                        body: notification.message,
                        tag: tag,
                        data: { url: url }
                    });
                }, index * 300); // Stagger notifications
            });
        };
        setInterval(pollForNotifications, NOTIFICATION_POLL_INTERVAL);

        // Handles immediate self-notifications flashed from the server.
        {% with messages = get_flashed_messages(with_categories = true) %}
        {% for category, message in messages %}
        {% if category == 'transient_notification' %}
        try {
            const notificationData = JSON.parse({{ message | tojson }});
    if (notificationData.type === 'self_mention' && notificationData.dealer_id) {
        setTimeout(() => {
            if (Notification.permission === "granted") {
                showBrowserNotification("New Dealer Note", {
                    body: notificationData.message,
                    tag: `dealer-note-${notificationData.note_id}`,
                    data: { url: `/dealer/${notificationData.dealer_id}#note-${notificationData.note_id}` }
                });
            }
        }, 500);
    }
                } catch (e) { console.error("Failed to parse transient notification:", e); }
    {% endif %}
    {% endfor %}
    {% endwith %}
});

    // Local time formatting
    document.querySelectorAll('.local-datetime').forEach(el => {
        try {
            el.textContent = new Date(el.dataset.timestamp).toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' });
        } catch (e) { console.error("Could not parse date:", el.dataset.timestamp); }
    });
</script>

{% endblock %}