{% extends "_base.html" %}

{% block title %}SB-{{ bulletin.sb_number }}{% endblock %}

{% block content %}
<div class="container-fluid p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-exclamation-triangle-fill text-warning"></i> SB-{{ bulletin.sb_number }}</h2>
        <div>
            <a href="{{ url_for('edit_service_bulletin', bulletin_id=bulletin.id) }}" class="btn btn-outline-primary">
                <i class="bi bi-pencil"></i> Edit
            </a>
            <a href="{{ url_for('list_service_bulletins') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to List
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card mb-3">
                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0">{{ bulletin.title }}</h4>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Issue Date:</strong> {{ bulletin.issue_date.strftime('%B %d, %Y') }}
                        </div>
                        <div class="col-md-6">
                            <strong>SB Number:</strong> {{ bulletin.sb_number }}
                        </div>
                    </div>

                    {% if bulletin.warranty_code or bulletin.labor_hours or bulletin.parsed_required_parts %}
                    <div class="row mb-3">
                        {% if bulletin.warranty_code %}
                        <div class="col-md-6">
                            <strong>Warranty Code:</strong> {{ bulletin.warranty_code }}
                        </div>
                        {% endif %}
                        {% if bulletin.labor_hours %}
                        <div class="col-md-6">
                            <strong>Labor Hours:</strong> {{ bulletin.labor_hours }}
                        </div>
                        {% endif %}
                    </div>
                    {% if bulletin.parsed_required_parts %}
                    <div class="mb-3">
                        <strong>Required Parts:</strong>
                        <ul class="mb-0 mt-1">
                            {% for part in bulletin.parsed_required_parts %}
                            <li>{{ part }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    {% endif %}

                    {% if bulletin.description %}
                    <div class="mb-3">
                        <strong>Description:</strong>
                        <p class="mt-2">{{ bulletin.description }}</p>
                    </div>
                    {% endif %}

                    {% if bulletin.pdf_filename %}
                    <div class="mb-3">
                        <a href="{{ url_for('serve_bulletin_pdf', bulletin_id=bulletin.id) }}" target="_blank"
                            class="btn btn-primary">
                            <i class="bi bi-file-pdf"></i> View PDF
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">Affected Models & Serial Ranges</h5>
                </div>
                <div class="card-body">
                    {% if bulletin.affected_models %}
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Model</th>
                                <th>Serial Range</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for model in bulletin.affected_models %}
                            <tr>
                                <td><strong>{{ model.model_name }}</strong></td>
                                <td><code>{{ model.serial_start }}</code> to <code>{{ model.serial_end }}</code></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class="text-muted">No affected models specified.</p>
                    {% endif %}
                </div>
            </div>

            {% if bulletin.pdf_filename %}
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">PDF Viewer</h5>
                </div>
                <div class="card-body p-0">
                    <iframe src="{{ url_for('serve_bulletin_pdf', bulletin_id=bulletin.id) }}"
                        style="width: 100%; height: 600px; border: none;"></iframe>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="col-md-4">
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-header">
                    <h5 class="mb-0">Actions</h5>
                </div>
                <div class="card-body">
                    <a href="{{ url_for('complete_service_bulletin', bulletin_id=bulletin.id) }}"
                        class="btn btn-success w-100 mb-2">
                        <i class="bi bi-check-circle"></i> Record Completion
                    </a>
                    <form method="POST" action="{{ url_for('delete_service_bulletin', bulletin_id=bulletin.id) }}"
                        onsubmit="return confirm('Are you sure you want to delete this bulletin?');">
                        <button type="submit" class="btn btn-outline-danger w-100">
                            <i class="bi bi-trash"></i> Delete Bulletin
                        </button>
                    </form>
                </div>

                {% if bulletin.completions %}
                <div class="card-header mt-3">
                    <h6 class="mb-0">Completion History ({{ bulletin.completions|length }})</h6>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        {% for completion in bulletin.completions %}
                        <div class="list-group-item px-0">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>{{ completion.serial_number }}</strong>
                                    <div class="mt-1">
                                        <span class="badge bg-success">{{ completion.status }}</span>
                                    </div>
                                    <small class="text-muted d-block mt-1">
                                        {{ completion.user.username }} - {{
                                        completion.completion_date.strftime('%m/%d/%Y') }}
                                    </small>
                                    {% if completion.notes %}
                                    <small class="text-muted d-block fst-italic mt-1">"{{ completion.notes }}"</small>
                                    {% endif %}
                                </div>
                                <button class="btn btn-sm btn-link text-primary"
                                    onclick="openEditCompletionModal('{{ completion.id }}', '{{ completion.completion_date.strftime('%Y-%m-%d') }}', '{{ completion.status }}', `{{ completion.notes or '' }}`)">
                                    <i class="bi bi-pencil"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Edit Completion Modal -->
<div class="modal fade" id="editCompletionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form id="editCompletionForm" method="POST">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Completion Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_completion_date" class="form-label">Completion Date</label>
                        <input type="date" class="form-control" id="edit_completion_date" name="completion_date"
                            required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_status" class="form-label">Status</label>
                        <select class="form-select" id="edit_status" name="status" required>
                            <option value="Completed">Completed</option>
                            <option value="Inspected">Inspected Only</option>
                            <option value="Replaced">Part Replaced</option>
                            <option value="N/A">Not Applicable</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit_notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="edit_notes" name="notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    function openEditCompletionModal(completionId, dateStr, status, notes) {
        const form = document.getElementById('editCompletionForm');
        // Set form action dynamically
        form.action = `/service_bulletins/completion/${completionId}/edit`;

        // Populate fields
        document.getElementById('edit_completion_date').value = dateStr;
        document.getElementById('edit_status').value = status;
        document.getElementById('edit_notes').value = notes;

        // Show modal
        new bootstrap.Modal(document.getElementById('editCompletionModal')).show();
    }

    // Enhancement: Auto-focus and Enter-to-Submit
    document.addEventListener('DOMContentLoaded', function () {
        const editModalEl = document.getElementById('editCompletionModal');
        if (editModalEl) {
            // Auto-focus the date field when modal opens
            editModalEl.addEventListener('shown.bs.modal', function () {
                document.getElementById('edit_completion_date').focus();
            });

            // Ensure Enter key triggers Submit (unless in Textarea)
            const form = document.getElementById('editCompletionForm');
            if (form) {
                form.addEventListener('keydown', function (event) {
                    // Check if Enter key pressed
                    if (event.key === 'Enter') {
                        // Allow default behavior for Textarea (newlines)
                        if (event.target.tagName === 'TEXTAREA') return;

                        // Otherwise, prevent default and click submit
                        event.preventDefault();
                        const submitBtn = form.querySelector('button[type="submit"]');
                        if (submitBtn) submitBtn.click();
                    }
                });
            }
        }
    });
</script>
{% endblock %}