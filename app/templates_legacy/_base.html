<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Tech Support Dashboard{% endblock %}</title>

    <!-- PWA & Mobile App Meta Tags -->
    <link rel="manifest" href="{{ url_for('manifest') }}">
    <meta name="theme-color" content="#0d6efd">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="KPM Dashboard">

    <!-- Stylesheets -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    {% block head_styles %}{% endblock %}
    <style>
        /* Allow quick links in navbar to wrap on mobile */
        @media (max-width: 991.98px) {
            .navbar-nav-scrollable {
                flex-wrap: wrap;
            }
        }
    </style>
</head>

<body class="bg-light">

    <!-- Main Navigation Bar  -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top no-print">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('dashboard') }}">KPM Technical Service Dashboard</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0"></ul>
                <div class="d-flex align-items-center ms-auto navbar-nav-scrollable gap-3">
                    <!-- Quick Links -->
                    <div class="d-flex gap-2 flex-wrap justify-content-end">
                        <a href="{{ url_for('list_check_sheets') }}" class="btn btn-primary btn-sm"><i
                                class="bi bi-file-earmark-check me-1"></i>Equipment Check Sheets</a>
                        <div class="vr d-none d-lg-block" style="opacity: 0.3;"></div>
                        <a href="{{ url_for('list_service_bulletins') }}" class="btn btn-warning btn-sm"><i
                                class="bi bi-exclamation-triangle-fill me-1"></i>Mandatory Service Bulletins</a>
                        <div class="vr d-none d-lg-block" style="opacity: 0.3;"></div>
                        <a href="http://www.scagtech.com/" target="_blank" rel="noopener noreferrer"
                            class="btn btn-secondary btn-sm">Scag Tech</a>
                        <a href="https://win.wrightmfg.com/" target="_blank" rel="noopener noreferrer"
                            class="btn btn-secondary btn-sm">Wright WIN</a>
                        <a href="https://kpmedi.com/Salesweb2" target="_blank" rel="noopener noreferrer"
                            class="btn btn-secondary btn-sm">Sales Web</a>
                        <a href="http://kpmint/?Page=MainMenu/MainMenu.cs" target="_blank" rel="noopener noreferrer"
                            class="btn btn-secondary btn-sm">KPM Int</a>
                        <a href="https://www.scaguniversity.com/learn" target="_blank" rel="noopener noreferrer"
                            class="btn btn-secondary btn-sm">Scag University</a>
                        <a href="https://auth.podium.com/" target="_blank" rel="noopener noreferrer"
                            class="btn btn-secondary btn-sm">Podium</a>
                        <a href="https://www.kpmedi.com/login.aspx" target="_blank" rel="noopener noreferrer"
                            class="btn btn-secondary btn-sm">KPMedi</a>
                        <a href="https://kpmedi.atlassian.net/wiki/spaces" target="_blank" rel="noopener noreferrer"
                            class="btn btn-primary btn-sm"><i class="bi bi-wikipedia me-2"></i>Confluence Wiki</a>
                    </div>
                    <!-- User Menu -->
                    <div class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle text-white" href="#" id="userDropdown" role="button"
                            data-bs-toggle="dropdown" aria-expanded="false"> <i class="bi bi-person-circle me-1"></i> {{
                            current_user.username }} </a>
                        <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-lg-end"
                            aria-labelledby="userDropdown">
                            {% if current_user.role == 'admin' %}
                            <li>
                                <h6 class="dropdown-header">Admin Menu</h6>
                            </li>
                            <li><a class="dropdown-item" href="{{ url_for('reports') }}"><i
                                        class="bi bi-graph-up me-2"></i>View Reports</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('manage_dealers') }}"><i
                                        class="bi bi-building me-2"></i>Manage Dealers</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('import_dealers') }}"><i
                                        class="bi bi-upload me-2"></i>Import Dealers</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('import_parts') }}"><i
                                        class="bi bi-receipt-cutoff me-2"></i>Import Part Prices</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('manage_manufacturers') }}"><i
                                        class="bi bi-tags-fill me-2"></i>Manage Manufacturers</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('manage_users') }}"><i
                                        class="bi bi-people-fill me-2"></i>Manage Users</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('manage_knowledge_base') }}"><i
                                        class="bi bi-book-half me-2"></i>Manage Knowledge Base</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('manage_stolen_units') }}"><i
                                        class="bi bi-exclamation-triangle-fill me-2 text-danger"></i>Manage Stolen
                                    Units</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            {% endif %}
                            <li><a class="dropdown-item" href="{{ url_for('profile') }}"><i
                                        class="bi bi-person-badge me-2"></i>My Profile</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('user_guide') }}"><i
                                        class="bi bi-book-half me-2"></i>User Guide</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('logout') }}"><i
                                        class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    {% block content %}{% endblock %}

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Register the service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register("{{ url_for('service_worker') }}").catch(err => console.error('Service worker registration failed:', err));
        }

        // --- Global Timezone Conversion Script ---
        function formatTimestamps() {
            const datetimeElements = document.querySelectorAll('.local-datetime');
            if (datetimeElements.length === 0) return;
            const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            datetimeElements.forEach(el => {
                const utcTimestamp = el.getAttribute('data-timestamp');
                if (utcTimestamp && !el.dataset.formatted) {
                    try {
                        const date = new Date(utcTimestamp);
                        const options = { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true, timeZone: userTimezone };
                        el.textContent = new Intl.DateTimeFormat('en-US', options).format(date);
                        el.dataset.formatted = 'true';
                        el.setAttribute('title', `UTC: ${utcTimestamp.replace('T', ' ').substring(0, 16)}`);
                    } catch (e) { console.error("Could not parse date:", utcTimestamp, e); }
                }
            });
        }
    </script>
    {% block body_scripts %}{% endblock %}
</body>

</html>