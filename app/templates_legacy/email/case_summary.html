<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>{{ subject }}</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; color: #333; }
        .container { max-width: 700px; margin: 20px auto; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        h1, h2, h3 { color: #0d6efd; }
        .case-details, .unit-details, .cost-details { margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 4px; }
        .case-details p, .unit-details p, .cost-details p { margin: 5px 0; }
        .notes-section { margin-top: 20px; }
        .note { border-left: 3px solid #e9ecef; padding-left: 15px; margin-bottom: 15px; }
        .note-header { font-size: 0.9em; color: #6c757d; }
        .footer { font-size: 0.8em; text-align: center; color: #888; margin-top: 20px; }
        .button { display: inline-block; padding: 10px 15px; background-color: #0d6efd; color: #ffffff; text-decoration: none; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { text-align: left; padding: 8px; border-bottom: 1px solid #ddd; }
        th { background-color: #f2f2f2; }
        .cost-total { font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>{{ subject }}</h1>

        <div class="case-details">
            <h3>Case Details</h3>
            <p><strong>Case ID:</strong> #{{ case.id }}</p>
            <p><strong>Status:</strong> {{ case.status }}</p>
            <p><strong>Created:</strong> {{ case.creation_timestamp.strftime('%Y-%m-%d %H:%M') }} UTC</p>
            <p><strong>Assigned To:</strong> {{ case.assigned_to or 'Unassigned' }}</p>
            <p><strong>Dealer:</strong> {{ case.dealer.name if case.dealer else 'N/A' }}</p>
            <p><strong>Caller:</strong> {{ case.caller_name or 'N/A' }}</p>
        </div>

        {% if case.unit %}
        <div class="unit-details">
            <h3>Unit & Owner Information</h3>
            <p><strong>Manufacturer:</strong> {{ case.unit.manufacturer or 'N/A' }}</p>
            <p><strong>Model:</strong> {{ case.unit.model_number or 'N/A' }}</p>
            <p><strong>Serial #:</strong> {{ case.unit.serial_number or 'N/A' }}</p>
            {% if case.unit.unit_hours %}<p><strong>Unit Hours:</strong> {{ case.unit.unit_hours }}</p>{% endif %}
            {% if case.unit.engine_model %}<p><strong>Engine Model:</strong> {{ case.unit.engine_model }}</p>{% endif %}
            {% if case.unit.engine_serial %}<p><strong>Engine Serial:</strong> {{ case.unit.engine_serial }}</p>{% endif %}
            <hr>
            {% if case.unit.owner_name %}<p><strong>Owner Name:</strong> {{ case.unit.owner_name }}</p>{% endif %}
            {% if case.unit.owner_company %}<p><strong>Owner Company:</strong> {{ case.unit.owner_company }}</p>{% endif %}
            {% if case.unit.owner_address %}<p><strong>Owner Address:</strong> {{ case.unit.owner_address }}</p>{% endif %}
            {% if case.unit.owner_phone %}<p><strong>Owner Phone:</strong> {{ case.unit.owner_phone }}</p>{% endif %}
            {% if case.unit.owner_email %}<p><strong>Owner Email:</strong> {{ case.unit.owner_email }}</p>{% endif %}
        </div>
        {% endif %}

        {% if case.case_type == 'Internal Repair' %}
        <div class="cost-details">
            <h3>Cost Summary</h3>
            <table>
                <tr>
                    <td>Parts Cost</td>
                    <td style="text-align: right;">{{ case.total_parts_cost | currency }}</td>
                </tr>
                <tr>
                    <td>Labor Cost</td>
                    <td style="text-align: right;">{{ case.total_labor_cost | currency }}</td>
                </tr>
                <tr class="cost-total">
                    <td>Total Repair Cost</td>
                    <td style="text-align: right;">{{ case.total_repair_cost | currency }}</td>
                </tr>
            </table>
            {% if case.parts_used %}
            <h4 style="margin-top: 20px;">Parts Used Breakdown</h4>
            <table>
                <thead>
                    <tr>
                        <th>Part #</th>
                        <th>Description</th>
                        <th style="text-align: right;">Total Cost</th>
                    </tr>
                </thead>
                <tbody>
                    {% for part in case.parts_used %}
                    <tr>
                        <td>{{ part.part_number }} (x{{ part.quantity }})</td>
                        <td>{{ part.description_at_time_of_use }}</td>
                        <td style="text-align: right;">{{ (part.quantity * part.cost_at_time_of_use) | currency }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
        </div>
        {% endif %}

        <div class="notes-section">
            <h2>Notes</h2>
            {% for note in case.notes|sort(attribute='timestamp') %}
            <div class="note">
                <div class="note-header">
                    <strong>{{ note.user or 'System' }}</strong> on {{ note.timestamp.strftime('%Y-%m-%d %H:%M') }} UTC
                </div>
                <div class="note-body">
                    {{ render_note_html(note.text, all_users=all_users, attachments=case.attachments) | safe }}
                </div>
            </div>
            {% else %}
            <p>No notes for this case.</p>
            {% endfor %}
        </div>

        <div style="text-align: center; margin-top: 30px;">
            <a href="{{ case_url }}" class="button">View Case in Dashboard</a>
        </div>

        <div class="footer">
            <p>This is an automated message from the KPM Tech Support Dashboard.</p>
            {% if reply_enabled %}
            <p>You can reply directly to this email to add a comment to the case even if you are not an authorized user.</p>
            {% endif %}
        </div>
    </div>
</body>
</html>